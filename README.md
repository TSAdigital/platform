# TSA<sup>Platform</sup>

## Обзор

TSA Platform — это веб-сервис, разработанный на основе [Yii 2 Basic Project Template](https://github.com/yiisoft/yii2-app-basic) и [AdminKit](https://github.com/adminkit/adminkit). Сервис предоставляется "как есть" без каких-либо гарантий. Пользователи несут полную ответственность за использование сервиса и все связанные с этим риски. Разработчик не несет ответственности за любые убытки или ущерб, возникшие в результате использования или невозможности использования сервиса.

### Демо
https://platform.tsa-digital.ru
admin/12345678

## Рекомендации

- Рекомендуется использовать PHP версии 7.4.

## Установка

### Установка через Composer

1. В корневом каталоге проекта выполните команду:

   ```bash
   composer install
   ```

2. Убедитесь, что параметр `cookieValidationKey` в файле `config/web.php` заполнен случайной строкой:

   ```php
   'request' => [
       'cookieValidationKey' => '<секретная случайная строка>',
   ],
   ```

### Настройка подключения к базе данных

Отредактируйте файл `config/db.php`, указав актуальные данные для подключения к базе данных:

```php
return [
    'class' => 'yii\db\Connection',
    'dsn' => 'mysql:host=localhost;dbname=yii2',
    'username' => 'root',
    'password' => '12345678',
    'charset' => 'utf8',
];
```

### Выполнение миграций

После настройки подключения выполните команду для применения миграций:

```bash
php yii migrate
```

### Импорт данных

Система поддерживает импорт данных из файла Excel, расположенного по пути `web/import/import.xlsx`. Пожалуйста, заполните этот файл актуальными данными.

Перед выполнением импорта в продуктивной среде настоятельно рекомендуется создать резервную копию базы данных для предотвращения потери данных.

Для выполнения импорта необходимо открыть терминал и, находясь в корневой директории проекта, выполнить следующую команду:

```bash
php yii import/init
```

В случае успешного завершения процесса импорта в папке `web/export` будет автоматически создан файл `users.txt`, содержащий учетные данные пользователей.

После сохранения файла `users.txt` в безопасном месте настоятельно рекомендуется удалить его из папки `web/export` в целях обеспечения безопасности. Также, по завершении работы, вы можете удалить файл `import.xlsx` из папки `web/import`.

## Настройка уведомлений через Telegram

### 1. Настройка Telegram API

Добавьте токен для Telegram API в файл `config/web.php` и `config/console.php`:

```php
'telegramBot' => [
    'class' => 'app\components\TelegramBot',
    'apiToken' => '<ваш токен>',
],
```

### 2. Настройка параметров

В файле `config/params.php` включите Telegram и добавьте ссылку на вашего бота:

```php
'telegram' => true,
'telegram_bot' => 'https://t.me/bot_url',
```

### 3. Настройка CRON

Предполагается, что сервер находится за NAT, Telegram не сможет отправлять запросы от пользователей напрямую. Поэтому нам придется самостоятельно опрашивать бота для получения обновлений.

Для автоматического получения обновлений от Telegram добавьте следующую строку в файл crontab:

```
* * * * * /usr/bin/php /var/www/project/yii telegram/update
```

### 4. Настройка очередей

Создайте службу (systemd service) для запуска слушателя очередей:

#### Пример службы

Создайте файл `/etc/systemd/system/yii2-queue.service` и добавьте следующее содержание:

```ini
[Unit]
Description=Yii2 Queue Listener
After=network.target

[Service]
User =www-data
Group=www-data
WorkingDirectory=/var/www/project
ExecStartPre=/bin/sleep 60
ExecStart=/usr/bin/php /var/www/project/yii queue/listen
Restart=always
RestartSec=60
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=yii2-queue

[Install]
WantedBy=multi-user.target
```

Замените пути на актуальные значения для вашей системы.

### 5. Активация службы

После создания файла службы выполните следующие команды для активации и запуска службы:

```bash
sudo systemctl daemon-reload
sudo systemctl enable yii2-queue.service
sudo systemctl start yii2-queue.service
```

Теперь ваша система готова к отправке уведомлений через Telegram.

## Работа с S3

### 1. Настройка подключения к S3

Для корректной работы с S3 необходимо указать параметры подключения в конфигурационных файлах `config/web.php` и `config/console.php`

```php
's3' => [
    'class' => 'app\components\S3',
    'key' => '<ваш ключ>',
    'secret' => '<ваш секретный ключ>',
    'region' => '<регион>',
    'bucket' => '<бакет>',
    'endpoint' => '<адрес сервера>',
],
```

### 2. Конфигурация параметров

В файле `config/params.php` активируйте поддержку S3 и установите срок действия ссылок на скачиваемые файлы:

```php
's3' => true,
's3_link_expiration' => 300,
```

### 3. Настройка CRON

Не используйте данный функционал для файлов большого размера. Для больших файлов необходимо дорабатывать функционал загрузки, чтобы обеспечить их корректную обработку.

Для автоматической загрузки файлов на сервер S3 добавьте следующую строку в файл crontab:

```
0 2 * * * /usr/bin/php /var/www/project/yii file/upload-file-to-s3
```

Для автоматической маркировки файлов, которые уже были загружены на сервер S3, добавьте следующую запись:

```
0 3 * * * /usr/bin/php /var/www/project/yii file/exists-file-to-s3
```

Для автоматического удаления локальных файлов, которые были успешно загружены на S3, используйте следующую команду:

```
0 4 * * * /usr/bin/php /var/www/project/yii file/delete-file-to-local-storage
```

## Использование Docker

Только для ознакомления, не используйте в продуктивной среде.

В корне проекта выполните следующую команду для запуска контейнеров:

```bash
docker-compose up -d
```

После выполнения этой команды может потребоваться некоторое время для завершения миграций и установки зависимостей.

## Тестирование

Откройте браузер и перейдите по адресу `http://localhost:8000`, чтобы получить доступ к странице входа.

**Учетные данные:**
- **Имя пользователя:** `admin`
- **Пароль:** `12345678`